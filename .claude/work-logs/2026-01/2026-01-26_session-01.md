# Work Session: Race Condition Fix and Lint Cleanup

**Date**: 2026-01-26
**Session Duration**: Approximately 1 hour
**Developer**: Teng Zheng
**Project**: Mahjong Vibes (Fuzhou Mahjong)

---

## Overview

Fixed a critical race condition bug causing tile count issues when players were marked as offline, and cleaned up a lint warning. The race condition occurred when both the turn timer and watchdog system tried to auto-play for the same turn concurrently.

## Goals & Objectives

**Primary Goals:**
- Fix lint warning from session-start
- Investigate and fix tile count bug reported by user

**Status**:
- ‚úÖ Completed: 2 goals
- üîÑ In Progress: 0 goals
- ‚è∏Ô∏è Blocked: 0 goals

## What Was Accomplished

### Session Health Check

**What was done:**
- Ran `/session-start` to verify project state
- All 131 tests passing
- Build passing
- One lint warning identified in ScoreEditModal.tsx

**Why it matters:**
This established a clean baseline and caught a minor code quality issue before starting feature work.

### Lint Warning Cleanup

**What was done:**
- Removed unused `netChange` variable in `ScoreEditModal.tsx:132`
- Committed as single-purpose fix (965f9c5)

**Why it matters:**
Maintains code quality and keeps linter output clean so real issues don't get missed.

**Technical approach:**
Simple variable removal - the calculation was being done but the result wasn't used.

### Race Condition Bug Investigation

**What was done:**
- Analyzed user-reported bug: "had 12 tiles instead of 16"
- Reviewed console logs showing multiple watchdog triggers
- Identified concurrent execution pattern between turn timer and offline watchdog
- Traced code paths in `useTurnTimer` and game page watchdog effect

**Why it matters:**
This was causing actual gameplay corruption - players ending up with wrong number of tiles breaks the fundamental game mechanics.

**Technical approach:**
- Used console logs to identify timing pattern
- Recognized both systems could trigger `autoPlayExpiredTurn()` for same turn
- Understood that brief "offline" status (tab backgrounding, network hiccup) would activate watchdog
- Both would read game state, both pass validation, both execute draw+discard
- Result: double draw and double discard in single turn

### Race Condition Fix

**What was done:**
- Added shared ref `autoPlayTriggeredForTurnRef` in game page component
- Both timer hook and watchdog effect check this ref before triggering auto-play
- First one to execute sets the ref, blocking the second
- Ref resets when turn advances

**Why it matters:**
Prevents tile count corruption and ensures only one auto-play trigger executes per turn, regardless of how many systems detect the expired turn.

**Technical approach:**
```typescript
// Shared ref between timer and watchdog
const autoPlayTriggeredForTurnRef = useRef<number | null>(null);

// Both systems check this before triggering
if (autoPlayTriggeredForTurnRef.current === currentTurn) {
  return; // Already triggered for this turn
}
autoPlayTriggeredForTurnRef.current = currentTurn;
await autoPlayExpiredTurn(roomCode, seatIndex);
```

**Why this approach:**
- Client-side coordination is simpler than Firebase transactions
- Sufficient since both triggers run on same client
- No need for distributed locking
- Minimal code change with clear intent

## Files Changed

### Modified
- `app/src/components/ScoreEditModal.tsx` - Removed unused `netChange` variable
- `app/src/app/game/[code]/page.tsx` - Added `autoPlayTriggeredForTurnRef` to coordinate auto-play triggers between timer and watchdog
- `app/CHANGELOG.md` - Documented both fixes

## Key Decisions Made

### Decision 1: Client-Side Coordination vs Firebase Transaction

**Context**: Need to prevent race condition between timer and watchdog triggering auto-play concurrently.

**Options considered:**
1. Firebase transaction to ensure atomic "claim" of turn before auto-playing
2. Client-side shared ref to coordinate between the two local triggers
3. Disable one of the triggers (timer or watchdog)

**Decision**: Client-side shared ref (#2)

**Rationale**:
- Both triggers run on the same client, so local coordination is sufficient
- Much simpler than distributed locking via Firebase
- No added Firebase operations or latency
- Clear code intent with minimal changes
- Option #3 would lose functionality - we need both systems

## Problems Solved

### Problem 1: Tile Count Corruption

**Issue**: Players occasionally ended up with 12 tiles instead of 16, breaking game state.

**Root Cause**:
- When player briefly marked as "offline" (tab backgrounding, network hiccup), watchdog would trigger
- Meanwhile, turn timer was still running and could also trigger
- Both would call `autoPlayExpiredTurn()` for the same turn
- Both would read game state, pass validation, and execute
- Result: two draws and two discards in one turn

**Solution**: Added shared ref that both systems check before triggering. First one to execute claims the turn, second one sees the ref and skips.

**Learning**: Multiple systems watching the same condition can race even within a single client. Need explicit coordination when multiple code paths can trigger the same action.

### Problem 2: Unused Variable Lint Warning

**Issue**: `netChange` variable calculated but never used in ScoreEditModal.

**Solution**: Removed the variable entirely.

**Learning**: Minor cleanup, but important to keep linter output clean.

## Code Changes Summary

### src/app/game/[code]/page.tsx

**Changes:**
```typescript
// Added shared ref to coordinate auto-play triggers
const autoPlayTriggeredForTurnRef = useRef<number | null>(null);

// In both timer callback and watchdog effect:
if (autoPlayTriggeredForTurnRef.current === game.currentTurn) {
  return; // Already triggered for this turn
}
autoPlayTriggeredForTurnRef.current = game.currentTurn;
await autoPlayExpiredTurn(roomCode, seatIndex);
```

**Purpose**: Prevents race condition where both turn timer and offline watchdog could trigger auto-play for the same turn concurrently.

**Notes**:
- Ref persists across renders but doesn't trigger re-renders
- Resets when turn advances (new turn number won't match ref)
- Simple coordination mechanism sufficient for same-client race

### src/components/ScoreEditModal.tsx

**Changes:**
Removed unused variable at line 132.

**Purpose**: Code cleanup to eliminate lint warning.

## Commands Executed

Key commands run during this session:

```bash
# Session start health check
npm test
npm run build
npm run lint

# After fixes
git add .
git commit -m "fix: Remove unused variable in ScoreEditModal"
git commit -m "fix: Prevent race condition between turn timer and watchdog"
```

**Results**: All tests passing, build successful, lint clean after fixes.

## Blockers & Issues

### Current Blockers

None identified.

### Issues to Monitor

- **Race condition fix effectiveness**: Monitor if tile count issues still occur in production
  - Potential solutions: If issues persist, may need Firebase-level coordination

- **Other potential races**: Could similar patterns exist elsewhere?
  - Worth reviewing other places where multiple systems watch same conditions

## Next Steps

### Immediate (Next Session)

1. **Test race condition fix**: Play several games with tab backgrounding and network interruptions
   - Prerequisites: Deploy fix to production or test environment
   - Estimated effort: 30-60 minutes of testing

2. **Consider merging feature/game-page-refactor**: Branch has accumulated several fixes
   - Prerequisites: Verify all fixes work in production
   - Estimated effort: 15 minutes

### Short-term (This Week)

- Continue with roadmap items (PWA, auto-pilot mode)
- Review other potential race conditions in codebase
- Monitor user reports for tile count issues

### Long-term (Future Considerations)

- Consider Firebase transactions for critical game state mutations if races continue
- Add automated testing for concurrent operations
- Review all places where multiple effects/hooks watch same game state

## Notes & Insights

- **Brief "offline" status is common**: Tab backgrounding, network hiccups, etc. can trigger offline detection even when user is still actively playing

- **Multiple watchers create races**: Even within a single client, having multiple systems react to the same condition requires coordination

- **Refs are good for same-client coordination**: Simple and effective for preventing duplicate actions from multiple React hooks/effects

- **Game state corruption is serious**: Tile count bugs break fundamental game mechanics - these need immediate attention

- **Console logs are invaluable**: The watchdog trigger logs helped identify the timing pattern that led to the race condition

## References

- Commit 965f9c5: Remove unused variable
- Commit 0ef2bc8: Prevent race condition
- Related issue: User report of 12-tile bug
- React refs documentation for coordination pattern

---

**Session logged**: 2026-01-26
**Next session pick-up point**: Test the race condition fix with AFK gameplay scenarios, then consider merging feature/game-page-refactor branch to main.
