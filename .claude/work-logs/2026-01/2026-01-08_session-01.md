# Work Session: Cumulative Scoring & Win Detection Bug Fixes

**Date**: 2026-01-08
**Session Duration**: ~2 hours
**Developer**: Teng Zheng
**Project**: Fujian Mahjong Multiplayer Game

---

## Overview

Implemented cumulative scoring system to track scores across multiple rounds with settlement calculations. Fixed multiple bugs in win detection and UI including the tile sorting algorithm for winning hand detection, duplicate win buttons, and tile count display issues.

## Goals & Objectives

**Primary Goals:**
- Implement cumulative scoring across rounds
- Add settlement calculator for end-of-session balancing
- Fix win detection bugs
- Improve game UI consistency

**Status**:
- Completed: All goals
- Added to backlog: Dealer streak system, Kong

## What Was Accomplished

### 1. Cumulative Scoring System

**What was done:**
- Added `SessionScores` type to track rounds and cumulative scores
- Created `recordRoundResult()` function to persist round results to Firebase
- Added `src/lib/settle.ts` with settlement calculation algorithm
- Integrated scoring into win declaration flow
- Added cumulative scores display on winner page
- Added "Settle" button with modal showing minimum transfers

**Technical approach:**
```typescript
// New types in types/index.ts
interface GameRound {
  roundNumber: number;
  winnerSeat: SeatIndex | null;
  winnerName: string;
  score: number;
  timestamp: number;
}

interface SessionScores {
  rounds: GameRound[];
  cumulative: Record<string, number>;
}
```

Settlement algorithm uses net position calculation and greedy matching to minimize transfers:
```typescript
// In settle.ts
export function calculateSettlement(rounds, playerNames) {
  const netPositions = calculateNetPositions(rounds);
  // Greedy match largest creditors with largest debtors
  // Returns minimum transactions (max 3 for 4 players)
}
```

**Impact:**
- Players can track scores across multiple rounds
- Easy session-end settlement with minimum transfers
- Clear display of who owes whom

### 2. Win Detection Algorithm Fix

**What was done:**
- Fixed `tryFormSetsAndPair()` algorithm that was failing on valid winning hands
- Root cause: Map iteration order was causing chow detection to fail
- Solution: Sort tiles by suit name then value before processing

**Problem scenario:**
- Hand: dots_7, dots_7, characters_4, characters_5
- Discard: characters_3
- Expected: Chow (3-4-5) + Pair (7-7) = WIN
- Actual: Returning false

**Root cause:**
Map insertion order caused `characters_4` to be processed first, which looked for 4-5-6 chow instead of recognizing characters_3 should form 3-4-5.

**Fix:**
```typescript
// Sort tiles before processing
tilesWithCount.sort((a, b) => {
  const parsedA = parseTileType(a);
  const parsedB = parseTileType(b);

  // Non-suit before suit (winds/dragons first)
  if (parsedA.category !== 'suit' && parsedB.category === 'suit') return -1;
  if (parsedA.category === 'suit' && parsedB.category !== 'suit') return 1;

  // Within suits, sort by suit name then value
  if (parsedA.category === 'suit' && parsedB.category === 'suit') {
    if (parsedA.suit !== parsedB.suit) {
      return (parsedA.suit || '').localeCompare(parsedB.suit || '');
    }
    return (parsedA.value as number) - (parsedB.value as number);
  }
  return 0;
});
```

### 3. UI Bug Fixes

**Duplicate win buttons:**
- Issue: Two win buttons showing during calling phase
- Fix: Only show "WIN! (Claim Discard)" during playing phase, not calling phase
- The calling phase has its own WIN button in the call options

**Tile count display:**
- Issue: Dealer's tile count showing 16 instead of 17 for other players
- Fix: Calculate `baseTileCount = isDealer ? 17 : 16` then subtract for melds

**Win button after Chow:**
- Issue: Win button showing "Self-Draw" after player called Chow
- Fix: Don't show win button if last action was chow/pung by current player

### 4. Hand Size Check Removal

**What was done:**
- Removed rigid hand size checks from win detection
- Now validates based on structure (5 sets + 1 pair) rather than exact count
- This prepares for future Kong implementation

**Why:**
- Hand size varies: 17 base, -2 per exposed meld, +1 for winning tile
- Kong will change this further (4 tiles instead of 3 per set)
- Structural validation is more robust

### 5. Test Infrastructure Updates

**What was done:**
- Updated `force-win.mjs` to accept seat and score parameters
- Created `restart-game.mjs` for testing multiple rounds
- Added debug logging to win detection for troubleshooting

## Files Changed

### Modified
- `src/lib/tiles.ts` - Fixed win detection algorithm, added tile sorting
- `src/lib/game.ts` - Integrated `recordRoundResult()` into win declarations
- `src/hooks/useGame.ts` - Added session scores subscription, removed hand size checks
- `src/app/game/[code]/page.tsx` - Added cumulative scores UI, settlement modal, fixed bugs
- `src/types/index.ts` - Added `GameRound`, `SessionScores`, `Settlement` types
- `scripts/force-win.mjs` - Added seat and score parameters

### Created
- `src/lib/settle.ts` - Settlement calculation algorithm
- `scripts/restart-game.mjs` - Restart game with rotated dealer
- `FUTURE_FEATURES.md` - Planned features documentation
- `README.md` - Updated with comprehensive project documentation

## Key Decisions Made

### Decision 1: Winner-Only Scoring

**Context**: How should round scores affect cumulative totals?

**Options:**
1. Winner gains, losers lose proportionally
2. Winner gains only, losers unchanged
3. Zero-sum with payer tracking

**Decision**: Winner gains only, losers unchanged

**Rationale**: Simpler tracking, settlement handles balancing at end. Matches casual play style.

### Decision 2: Tile Sorting for Win Detection

**Context**: Win detection was failing due to Map iteration order.

**Options:**
1. Sort tiles before building Map
2. Sort during iteration
3. Try all possible orderings (brute force)

**Decision**: Sort during iteration in `tryFormSetsAndPair()`

**Rationale**: Sorting at detection time ensures consistent behavior regardless of input order. More efficient than brute force.

### Decision 3: Structural vs Count-Based Validation

**Context**: Should win detection check exact hand size or structural validity?

**Options:**
1. Strict hand size check (17 tiles exactly)
2. Structural validation (5 sets + 1 pair)
3. Both checks

**Decision**: Structural validation only

**Rationale**: Handles edge cases better (varying meld counts, future Kong support). More flexible and robust.

## Problems Solved

### Problem 1: Win Detection False Negatives

**Issue**: Valid winning hands returning false in `canWinOnDiscard()`.

**Root Cause**: JavaScript Map iteration order is insertion-based, causing tiles to be processed in wrong order for chow detection.

**Solution**: Sort tiles by category (non-suit first), then suit name, then value before processing. This ensures 3-4-5 is detected before trying to use 4 in a different set.

### Problem 2: Duplicate UI Elements

**Issue**: Two win buttons appearing during calling phase.

**Root Cause**: Separate win button for "claim discard" was showing during both playing and calling phases, duplicating the calling phase's built-in win button.

**Solution**: Restrict "WIN! (Claim Discard)" button to playing phase only.

### Problem 3: Inconsistent Tile Counts

**Issue**: Other players' tile counts showing wrong numbers.

**Root Cause**: Not accounting for dealer's extra tile (17 vs 16) in display calculation.

**Solution**: Calculate base tile count from dealer status, then adjust for exposed melds.

## Code Changes Summary

### Settlement Algorithm (settle.ts)
```typescript
export function calculateNetPositions(rounds: GameRound[]): Record<string, number> {
  const positions: Record<string, number> = { seat0: 0, seat1: 0, seat2: 0, seat3: 0 };

  for (const round of rounds) {
    if (round.winnerSeat !== null && round.score > 0) {
      // Winner gains full score
      positions[`seat${round.winnerSeat}`] += round.score;
      // Each loser pays 1/3 of score
      const losersPayment = round.score / 3;
      for (let i = 0; i < 4; i++) {
        if (i !== round.winnerSeat) {
          positions[`seat${i}`] -= losersPayment;
        }
      }
    }
  }
  return positions;
}
```

### Win Detection Fix (tiles.ts)
- Added tile sorting before set/pair detection
- Removed strict hand size checks
- Added debug logging for troubleshooting

### UI Updates (page.tsx)
- Cumulative scores section on winner page
- Settlement modal with transfer calculations
- Fixed win button display logic
- Fixed tile count calculation

## Next Steps

### Immediate
- Continue manual testing of win detection edge cases
- Verify settlement calculations are correct

### Short-term (Future Features)
- Dealer streak bonus system
- Kong (quad) declarations

### Long-term
- Automated test suite for game logic
- Mobile-responsive layout improvements
- Sound effects and animations

## Technical Debt Identified

- Debug logging in tiles.ts should be removed or made conditional
- Settlement algorithm could be optimized for edge cases
- No unit tests for settle.ts calculations

---

**Session logged**: 2026-01-08
**Commits this session**: Pending (cumulative scoring, win detection fixes, UI improvements)
**Next session pick-up point**: Continue testing win detection, consider implementing dealer streak system
