# Work Log: 2026-01-13 Session 01

## Summary
Implemented full keyboard selection for Kong actions, fixing three bugs with the kong selection mode and consolidating all kong buttons into a single unified button.

## Completed

### Kong Keyboard Selection Improvements
- **Consolidated all kong buttons** into single unified KONG button that works for both concealed kongs and pung upgrades
- **Fixed arrow key navigation** - Arrow keys now navigate between kong options (was blocked by tile selection handler)
- **Fixed Space bar behavior** - Space no longer confirms kong selection (only Enter does)
- **Removed redundant label** - Cleaned up "Concealed Kong (1/2)" text, kept only counter on confirm button
- **Visual highlighting** - All 4 tiles in a kong option are grouped with yellow border when focused

### Test Setup for Kong
- Created TEST_KONG_MODE with hands for testing:
  - Dealer gets 2 concealed kongs (4x 1-dots, 4x 5-bamboo)
  - Dealer gets triple (3x 3-characters) for pung upgrade testing
  - Seat 1 gets isolated characters_3_3 tile with pairs to encourage discarding it
- Verified arrow key navigation between options works
- Verified Enter confirms, Space does not
- Disabled TEST_KONG_MODE before final commit

## Commits
1. `0e4eb5a` feat: Add Kong keyboard selection with unified button
2. `8fd8e34` docs: Update changelog and roadmap with keyboard controls

## Files Changed
- `src/app/game/[code]/page.tsx` - Kong selection state, keyboard handlers, UI consolidation
- `src/components/SettingsModal.tsx` - Added kong selection shortcuts documentation
- `src/lib/game.ts` - TEST_KONG_MODE setup (now disabled)
- `CHANGELOG.md` - Added keyboard control features
- `FUTURE_FEATURES.md` - Marked keyboard features complete

## Technical Notes

### Kong Selection State
```typescript
const [kongSelectionMode, setKongSelectionMode] = useState(false);
const [focusedKongIndex, setFocusedKongIndex] = useState(0);

type KongOption =
  | { type: 'concealed'; tileType: TileType }
  | { type: 'upgrade'; meldIndex: number; tileFromHand: TileId; tileType: TileType };

const combinedKongOptions: KongOption[] = useMemo(() => {
  // Merges concealed kong options and pung upgrade options
}, [concealedKongOptions, pungUpgradeOptions]);
```

### Key Fix: Arrow Key Conflict
The tile selection handler was catching arrow keys before kong selection could process them:
```typescript
// Before: Arrow keys blocked in kong mode
if (isDiscardPhase && myHand.length > 0) { ... }

// After: Exclude kong selection mode
if (isDiscardPhase && myHand.length > 0 && !kongSelectionMode) { ... }
```

## Next Session
- Consider adding pung upgrade test that reliably triggers (current bot AI doesn't always discard the expected tile)
- Calling phase timer (still on roadmap, previously reverted due to Firebase issues)
