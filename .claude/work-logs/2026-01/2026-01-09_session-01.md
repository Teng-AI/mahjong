# Work Session: Bot Bug Fixes and Chow Logic Improvements

**Date**: 2026-01-09
**Project**: Fujian Mahjong Multiplayer Game

---

## Overview

This session focused on fixing critical bot issues where bots would get stuck or take multiple turns at once, and fixing the bot chow logic so bots actually call chow when appropriate.

## What Was Accomplished

### 1. Bot Stuck/Multiple Turn Bug Fix

**Problem**: Bots would either get stuck (not taking turns) or take multiple turns at once. The game would work after refreshing but not continue automatically.

**Root Causes Identified**:
1. Multiple useEffect executions passed lock checks before any could set the lock
2. Ref-based locks don't trigger re-renders when released - after bot action completes and lock is released in setTimeout, the effect doesn't re-run

**Solution**: Replaced complex ref-based locking with React's idiomatic effect cleanup pattern using a `cancelled` flag:

```typescript
useEffect(() => {
  // ... early returns for invalid states ...

  let cancelled = false;

  const runBotActions = async () => {
    await new Promise(resolve => setTimeout(resolve, 1000));
    if (cancelled) return;

    // ... bot logic ...
  };

  runBotActions();

  return () => {
    cancelled = true;
  };
}, [dependencies]);
```

**File Modified**: `app/src/hooks/useBotRunner.ts`

### 2. Bot Chow Logic Fix

**Problem**: Bots were never calling chow despite having valid chow options.

**Root Cause**: The `shouldCallChow` thresholds were too strict - only calling chow if shanten strictly improved, which rarely happens with chow.

**Solution**: Made thresholds more aggressive by difficulty level:

| Difficulty | Threshold |
|------------|-----------|
| Easy | Call if shanten stays same, improves, or only gets 1 worse |
| Medium | Call if shanten stays same or improves |
| Hard | Same as medium, but slightly more conservative in late game (wall < 20) |

**Debug Logging Added**:
```
[Bot X] Next in turn check: seat=X, discarder=Y, nextSeat=Z, isNext=true/false
[Bot X] Chow options available: N
[Chow eval] shanten before=X, after=Y, difficulty=Z, wall=N
[Bot X] Should call chow: yes/no
```

**File Modified**: `app/src/hooks/useBotRunner.ts`

### 3. Bot Delay Adjustment

Changed bot action delay from variable timing to a fixed 1 second delay for better UX.

### 4. Documentation Cleanup

Updated `FUTURE_FEATURES.md` to reflect completed features:
- Winner screen redesign - COMPLETED
- Sound effects - COMPLETED
- Bot difficulty selection UI - COMPLETED
- Adjustable bot difficulty logic - COMPLETED

**Remaining Feature**: Kong (Quad) only

## Files Changed

| File | Changes |
|------|---------|
| `app/src/hooks/useBotRunner.ts` | Effect cleanup pattern, chow thresholds, debug logging |
| `app/FUTURE_FEATURES.md` | Removed completed features, kept Kong only |

## Key Technical Decisions

### Decision: Effect Cleanup vs Ref-Based Locking

**Context**: Needed to prevent multiple concurrent bot actions without causing stale state issues.

**Options**:
1. Ref-based locking with timestamps
2. React effect cleanup with cancelled flag
3. External state management (Redux/Zustand)

**Chosen**: Option 2 - Effect cleanup pattern

**Rationale**:
- React-idiomatic approach
- Automatically handles cleanup when dependencies change
- No re-render issues (refs don't trigger re-renders)
- Simpler code, easier to reason about

### Decision: Aggressive Chow Thresholds

**Context**: Bots never called chow because strict improvement is rare.

**Chosen**: Allow chow when shanten stays same or gets slightly worse (for easy bots)

**Rationale**:
- Chow is a valid strategic move even if it doesn't immediately improve hand
- Makes bots more realistic and varied
- Easy bots should be more aggressive (makes game easier for new players)

## Problems Solved

1. **Bot infinite loop** - Multiple effects running concurrently → Fixed with cleanup pattern
2. **Game stuck after human turn** - Lock held during human's turn → Fixed with early return before locking
3. **Lock release not triggering re-render** - Ref changes don't cause re-render → Fixed by removing refs entirely
4. **Bots not chowing** - Thresholds too strict → Made more aggressive

## Next Steps

- Monitor bot behavior for any remaining edge cases
- Consider adding more comprehensive bot action logging if issues arise
- Implement Kong (Quad) feature when ready

---

**Session logged**: 2026-01-09
